---
title: "Assignment 6"
author: HYUN KO
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, fig.height = 3)
library(tidyverse)
library(lubridate)
library(readxl)
## Note: this code assumes viridis.R is two steps up the file directory tree
## Comment it out and use the line below if the file is in the same directory
## Or comment out both lines if you do not have the file
source("../../scripts/viridis.R")
```


#### Due Friday, October 9, 11:59 PM

### Problems

### 1

> Transform and combine the necessary data sets so that you have two rows for each zip code (one row for each sex) and the columns of data listed below. Note that you will need to eliminate the data on obesity among children, and summarize the data across age cohorts within each zip code to accomplish this task.  Display the first six rows of the transformed and combined data frame using the function `head()`.

```{r}
obesity <- read_csv("../../data/obesity-hw.csv")
education <- read_csv("../../data/education.csv") 

education <- education %>%
  rename(male = pct_m_bach, female = pct_f_bach) %>%
  pivot_longer(c("male", "female"), names_to = "sex", values_to = "pct_bach")
  
obesity1 <- obesity %>%
  drop_na() %>%
  filter(age != "05-17") %>%
  rename(adult_n = pop) %>%
  mutate(obese_n = adult_n * (obese / bmi)) %>%
  select(zip, sex, adult_n, obese_n) %>%
  group_by(zip, sex) %>%
  summarize(adult_n = sum(adult_n), obese_n = sum(obese_n), obese_p = (obese_n / adult_n)) 
  
result <- left_join(education, obesity1, by=c('zip', 'sex')) %>%
  select(zip, sex, adult_n, obese_n, obese_p, pct_bach) %>%
  drop_na()

head(result)
```


### 2

> Using the data from Question 1, we are going to investigate connections between obesity and education status (at least a bachelors degree or no bachelors degree) by sex.  For this question, calculate the *estimated percentage of adults in Wisconsin who are obese* among those with at least a bachelors degree by sex.  Similarly, calculate the *estimated percentage of adults in Wisconsin who are obese* among those without a bachelors degree by sex.  
> Display these values in a 2-by-2 table, i.e., a table with two rows - one for male and one for female, and two columns - one for each of the estimated percentages noted above (plus the first column sex). 
> State any assumptions you need to make when carrying out these calculations. 
(Recall that you need to sum up totals of people before finding proportions.)

```{r}
obese_edu <- result %>%
  mutate(bach_n = adult_n * (pct_bach / 100), non_bach_n = adult_n - bach_n) %>%
  group_by(zip, sex) %>%
  summarize(total_bach_n = sum(bach_n), total_non_bach_n = sum(non_bach_n), total_n = sum(adult_n)) %>%
  mutate(obese_bach = (total_bach_n / total_n) * 100, obese_non_bach = (total_non_bach_n / total_n) * 100) %>%
  select(sex, obese_bach, obese_non_bach)

obese_edu
```


### 3

> Make a scatter plot that displays the proportion of a zip code aged 25+ with a bachelor's degree on the x-axis and the proportion obese on the y axis. Use different colors for each sex and add a trend line or curve for each sex.
Create appropriate labels and titles for the plot.
Comment on any apparent patterns in the data.

```{r}
ggplot(result, aes(x = pct_bach, y = obese_p)) +
  geom_point(aes(color = sex)) +
  geom_smooth() +
  xlab("Proportion of aged 25+ with bachelor's degree") +
  ylab("Obesity Proportion")
```
# The lesser people had bachelor's degree, the higher chances of people getting obese in this data. 
# That is applicable to both sexes.

### 4

> Transform and combine the necessary data sets so that you have one row for each zip code and the following columns of data. Note that you will need to eliminate the data on obesity among children and summarize the obesity data across age and sex cohorts within each zip code to accomplish this task. Display the first six rows of the transformed and combined data frame using the function `head()`.

```{r}
obesity2 <- read_csv("../../data/obesity-hw.csv") %>%
  drop_na() %>%
  filter(age != "05-17") %>%
  group_by(zip) %>%
  rename(adult_n = pop) %>%
  mutate(obese_n = adult_n * (obese / bmi)) %>%
  summarize(adult_n = sum(adult_n), obese_n = sum(obese_n)) %>%
  mutate(obese_p = obese_n / adult_n, non_obese_n = adult_n - obese_n)
  
income <- read_csv("../../data/income.csv") %>%
  drop_na()

income_obese <- left_join(obesity2, income, by="zip")

ru_ur <- read_csv("../../data/rural-urban.csv") %>%
  drop_na()

final <- left_join(income_obese, ru_ur, by = "zip") %>%
  mutate(urban_n = adult_n * (p_urban)) %>%
  mutate(rural_n = adult_n * (1 - p_urban)) %>%
  select(-population, -rural, -urban)

head(final)
```


### 5

> Using the previous question's data frame, create a new variable `ru` that takes the value `rural` if 50% or more of the residents in the zip code live in rural areas, otherwise assign the value `urban`.
Assume each adult in a zipcode has the median household income from that zip code.  Under this assumption, calculate and display the average income for obese and non-obese adults for the state by `ru`.  Your answer should have two rows and two columns.

```{r}
final %>%
  mutate(ru = ifelse(rural_n < urban_n, "urban", "rural")) %>%
  group_by(ru)
```


### 6

> Make a scatter plot with one point for each zip code with the median household income on the x-axis and the percentage of obese adults on the y-axis. Make the area of the points proportional to the number of households represented (check out the `size` aesthetic).
Create appropriate labels and titles for the plot, and facet by `ru`.
Add a trend line/curve and comment on any apparent patterns.

```{r}
final6 <- final %>%
  mutate(ru = ifelse(rural_n < urban_n, "urban", "rural"))

ggplot(final6, aes(x=income, y=obese_p * 100)) +
  geom_point(aes(size = households)) +
  geom_smooth(method = "lm") +
  facet_wrap(~ru) +
  xlab("Income") +
  ylab("Obesity Proportion") +
  ggtitle("Income ~ Obesity Relationship by area")
```
# High-income people have lesser obesity rates.
# Larger households lead to lower obesity rates.


### 7


> Transform and combine the necessary data sets so that you have four rows for each zip code (one row for the four age groups defined next) and the columns of data listed below.  Define new age categories as "05-17", "18-34", "35-74", and "75-plus".  Note that you will need to summarize the data across sex cohorts within each zip code to accomplish this task.  Display the first six rows of the transformed and combined data frame using the function `head()`.

```{r}
obesity3 <- read_csv("../../data/obesity-hw.csv") %>%
  drop_na() %>%
  mutate(age_group = case_when(
  age == "05-17" ~ "05-17",
  age == "18-34" ~ "18-34",
  age == "35-54" ~ "35-54",
  age == "55-74" ~ "55-74",
  age == "75-plus" ~ "75-plus")) %>%
  rename(pop_n = pop) %>%
  mutate(obese_n = pop_n * (obese / bmi)) %>%
  group_by(zip, age_group) %>%
  summarize(pop_n = sum(pop_n), obese_n = sum(obese_n), obese_p = sum(obese_n / pop_n))

ru_ur2 <- read_csv("../../data/rural-urban.csv") %>%
  drop_na()

data7 <- left_join(obesity3, ru_ur2, by = "zip") %>%
  mutate(urban_n = pop_n * (p_urban)) %>%
  mutate(rural_n = pop_n * (1-p_urban))  %>%
  select(-urban, -rural, -population)

head(data7)
```


### 8

> Using the previous question's data frame, calculate estimated percentages of obese individuals by age group and if they live in an urban or rural household.
Display these values in a 4 by 2 table with one row for each age group range and separate columns for rural and urban.

```{r}
data8 <- data7 %>%
  mutate(ru = ifelse(rural_n < urban_n, "urban", "rural")) %>%
  group_by(age_group, ru) %>%
  summarize(obese_pct = ( sum(obese_n) / sum(pop_n) ) * 100)

data9 <- data8 %>%
  pivot_wider(names_from = ru, values_from = obese_pct)

data9 
```


### 9

> Create a scatter plot with a point for each zip code and age_group to show percentage urban on the x-axis and percentage obese on the y-axis. Assign the color by age_group.
Create appropriate labels and titles for the plot.
Comment on any patterns in the plot.

```{r}
obesity4 <- read_csv("../../data/obesity-hw.csv") %>%
  drop_na() %>%
  mutate(age_group = case_when(
  age == "05-17" ~ "05-17",
  age == "18-34" ~ "18-34",
  age == "35-54" ~ "35-54",
  age == "55-74" ~ "55-74",
  age == "75-plus" ~ "75-plus")) %>%
  rename(pop_n = pop) %>%
  mutate(obese_n = pop_n * (obese / bmi)) %>%
  group_by(zip, age_group) %>%
  summarize(pop_n = sum(pop_n), obese_n = sum(obese_n), obese_p = sum(obese_n / pop_n))

ru_ur3 <- read_csv("../../data/rural-urban.csv") %>%
  drop_na()

final_data <- left_join(obesity4, ru_ur3, by = "zip") 

ggplot(final_data, aes(x = p_urban * 100, y = obese_p * 100)) +
  geom_point(aes(color=age_group)) +
  xlab("Urban Percentage") +
  ylab("Obesity Rate") +
  ggtitle("Relationship Between Urban Percentage and Obesity")
```
# Age group of 35-73 had the highest and 05-17 had the lowest obesity rate.
# Urban Percentage had remarkable connection with Obesity Rate.

